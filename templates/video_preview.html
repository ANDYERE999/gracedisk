{% extends "base.html" %}

{% block content %}
<div class="video-preview-container">
    <div class="video-header">
        <div class="breadcrumb">
            <a href="{{ url_for('browse', subpath=parent_path) if parent_path else url_for('root') }}">&larr; è¿”å›æ–‡ä»¶åˆ—è¡¨</a>
            <span class="separator">/</span>
            <span class="current-file">{{ filename }}</span>
        </div>
    </div>

    <div class="video-player-wrapper">
        <video id="videoPlayer" class="video-player" preload="metadata" onclick="togglePlay()">
            <source src="{{ url_for('get_file_data', path=file_path) }}" type="video/mp4">
            <source src="{{ url_for('get_file_data', path=file_path) }}" type="video/webm">
            <source src="{{ url_for('get_file_data', path=file_path) }}" type="video/ogg">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ HTML5 video æ ‡ç­¾ã€‚
        </video>
        
        <div class="video-controls" id="videoControls">
            <div class="progress-container">
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-handle" id="progressHandle"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">00:00</span>
                    <span class="time-separator">/</span>
                    <span id="duration">00:00</span>
                </div>
            </div>
            
            <div class="control-buttons">
                <div class="left-controls">
                    <button class="control-btn" id="playPauseBtn" onclick="togglePlay()">
                        <span class="play-icon">â–¶ï¸</span>
                        <span class="pause-icon" style="display: none;">â¸ï¸</span>
                    </button>
                    <div class="volume-control">
                        <button class="control-btn" id="volumeBtn" onclick="toggleMute()">
                            <span class="volume-icon">ğŸ”Š</span>
                            <span class="mute-icon" style="display: none;">ğŸ”‡</span>
                        </button>
                        <div class="volume-slider">
                            <input type="range" id="volumeSlider" min="0" max="100" value="100" class="slider">
                        </div>
                    </div>
                </div>
                
                <div class="right-controls">
                    <div class="speed-control">
                        <select id="speedSelect" class="speed-select" onchange="changeSpeed()">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2x</option>
                        </select>
                    </div>
                    <button class="control-btn" id="fullscreenBtn" onclick="toggleFullscreen()">
                        <span class="fullscreen-icon">â›¶</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.video-preview-container {
    min-height: 100vh;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 2rem;
}

.video-header {
    margin-bottom: 2rem;
}

.breadcrumb {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.breadcrumb a {
    color: #23AAF2;
    text-decoration: none;
    font-weight: 500;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

.separator {
    color: #6c757d;
}

.current-file {
    color: #fff;
    font-weight: 600;
}

.video-player-wrapper {
    position: relative;
    max-width: 100%;
    margin: 0 auto;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.video-player {
    width: 100%;
    height: auto;
    max-height: 70vh;
    display: block;
}

.video-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
    padding: 1.5rem 1rem 1rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.video-player-wrapper:hover .video-controls {
    opacity: 1;
}

.progress-container {
    margin-bottom: 1rem;
}

.progress-bar {
    position: relative;
    height: 6px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
    cursor: pointer;
    margin-bottom: 0.5rem;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

.progress-fill {
    height: 100%;
    background: #23AAF2;
    border-radius: 3px;
    transition: width 0.1s linear;
    width: 0%;
}

.progress-handle {
    position: absolute;
    top: -3px;
    width: 12px;
    height: 12px;
    background: #23AAF2;
    border-radius: 50%;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s ease, transform 0.1s ease;
    left: 0%;
    transform: translateX(-50%);
    z-index: 2;
}

.progress-handle:hover {
    transform: translateX(-50%) scale(1.2);
}

.progress-handle.dragging {
    opacity: 1 !important;
    transform: translateX(-50%) scale(1.3);
}

.progress-bar:hover .progress-handle {
    opacity: 1;
}

.time-display {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
}

.time-separator {
    margin: 0 0.5rem;
}

.control-buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.left-controls, .right-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.control-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}

.control-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

.volume-control {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.volume-slider {
    width: 80px;
}

.slider {
    width: 100%;
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    outline: none;
    -webkit-appearance: none;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    background: #23AAF2;
    border-radius: 50%;
    cursor: pointer;
}

.slider::-moz-range-thumb {
    width: 14px;
    height: 14px;
    background: #23AAF2;
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

.speed-select {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 0.3rem 0.5rem;
    border-radius: 4px;
    font-size: 0.9rem;
}

.speed-select option {
    background: #333;
    color: white;
}

@media (max-width: 768px) {
    .video-preview-container {
        padding: 1rem;
    }
    
    .control-buttons {
        flex-direction: column;
        gap: 1rem;
    }
    
    .volume-control {
        display: none;
    }
}
</style>

<script>
const video = document.getElementById('videoPlayer');
const playPauseBtn = document.getElementById('playPauseBtn');
const progressBar = document.getElementById('progressBar');
const progressFill = document.getElementById('progressFill');
const progressHandle = document.getElementById('progressHandle');
const currentTimeEl = document.getElementById('currentTime');
const durationEl = document.getElementById('duration');
const volumeBtn = document.getElementById('volumeBtn');
const volumeSlider = document.getElementById('volumeSlider');
const speedSelect = document.getElementById('speedSelect');

// æ’­æ”¾/æš‚åœ
function togglePlay() {
    if (video.paused) {
        video.play();
        document.querySelector('.play-icon').style.display = 'none';
        document.querySelector('.pause-icon').style.display = 'inline';
    } else {
        video.pause();
        document.querySelector('.play-icon').style.display = 'inline';
        document.querySelector('.pause-icon').style.display = 'none';
    }
}

// æ ¼å¼åŒ–æ—¶é—´
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// æ›´æ–°è¿›åº¦æ¡
function updateProgress() {
    if (video.duration) {
        const progress = (video.currentTime / video.duration) * 100;
        progressFill.style.width = progress + '%';
        progressHandle.style.left = progress + '%';
        currentTimeEl.textContent = formatTime(video.currentTime);
    }
}

// è¿›åº¦æ¡æ‹–æ‹½ç›¸å…³å˜é‡
let isDragging = false;
let wasPaused = false;

// è®¾ç½®è¿›åº¦
function setProgress(e) {
    const rect = progressBar.getBoundingClientRect();
    const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    if (video.duration) {
        video.currentTime = percent * video.duration;
    }
}

// è¿›åº¦æ¡æ‹–æ‹½å¼€å§‹
function startDrag(e) {
    isDragging = true;
    wasPaused = video.paused;
    video.pause(); // æ‹–æ‹½æ—¶æš‚åœè§†é¢‘
    progressHandle.classList.add('dragging');
    document.body.style.cursor = 'grabbing';
    setProgress(e);
    e.preventDefault();
}

// è¿›åº¦æ¡æ‹–æ‹½ä¸­
function drag(e) {
    if (isDragging) {
        setProgress(e);
        e.preventDefault();
    }
}

// è¿›åº¦æ¡æ‹–æ‹½ç»“æŸ
function endDrag(e) {
    if (isDragging) {
        isDragging = false;
        progressHandle.classList.remove('dragging');
        document.body.style.cursor = '';
        if (!wasPaused) {
            video.play(); // å¦‚æœä¹‹å‰æ˜¯æ’­æ”¾çŠ¶æ€ï¼Œæ¢å¤æ’­æ”¾
        }
        e.preventDefault();
    }
}

// éŸ³é‡æ§åˆ¶
function toggleMute() {
    if (video.muted) {
        video.muted = false;
        volumeSlider.value = video.volume * 100;
        document.querySelector('.volume-icon').style.display = 'inline';
        document.querySelector('.mute-icon').style.display = 'none';
    } else {
        video.muted = true;
        document.querySelector('.volume-icon').style.display = 'none';
        document.querySelector('.mute-icon').style.display = 'inline';
    }
}

// éŸ³é‡æ»‘å—
volumeSlider.addEventListener('input', function() {
    video.volume = this.value / 100;
    video.muted = this.value == 0;
    if (video.muted) {
        document.querySelector('.volume-icon').style.display = 'none';
        document.querySelector('.mute-icon').style.display = 'inline';
    } else {
        document.querySelector('.volume-icon').style.display = 'inline';
        document.querySelector('.mute-icon').style.display = 'none';
    }
});

// æ’­æ”¾é€Ÿåº¦
function changeSpeed() {
    video.playbackRate = parseFloat(speedSelect.value);
}

// å…¨å±
function toggleFullscreen() {
    if (!document.fullscreenElement) {
        video.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

// äº‹ä»¶ç›‘å¬
video.addEventListener('timeupdate', updateProgress);
video.addEventListener('loadedmetadata', function() {
    durationEl.textContent = formatTime(video.duration);
});

// è¿›åº¦æ¡äº‹ä»¶ç›‘å¬
progressBar.addEventListener('click', function(e) {
    if (!isDragging) {
        setProgress(e);
    }
});

progressBar.addEventListener('mousedown', startDrag);
document.addEventListener('mousemove', drag);
document.addEventListener('mouseup', endDrag);

// è§¦æ‘¸äº‹ä»¶æ”¯æŒï¼ˆç§»åŠ¨ç«¯ï¼‰
progressBar.addEventListener('touchstart', function(e) {
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    startDrag(mouseEvent);
    e.preventDefault();
});

document.addEventListener('touchmove', function(e) {
    if (isDragging) {
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        drag(mouseEvent);
        e.preventDefault();
    }
});

document.addEventListener('touchend', function(e) {
    if (isDragging) {
        const mouseEvent = new MouseEvent('mouseup');
        endDrag(mouseEvent);
        e.preventDefault();
    }
});

// é”®ç›˜å¿«æ·é”®
document.addEventListener('keydown', function(e) {
    switch(e.code) {
        case 'Space':
            e.preventDefault();
            togglePlay();
            break;
        case 'ArrowLeft':
            video.currentTime -= 10;
            break;
        case 'ArrowRight':
            video.currentTime += 10;
            break;
        case 'ArrowUp':
            video.volume = Math.min(1, video.volume + 0.1);
            volumeSlider.value = video.volume * 100;
            break;
        case 'ArrowDown':
            video.volume = Math.max(0, video.volume - 0.1);
            volumeSlider.value = video.volume * 100;
            break;
        case 'KeyM':
            toggleMute();
            break;
        case 'KeyF':
            toggleFullscreen();
            break;
    }
});
</script>
{% endblock %}
