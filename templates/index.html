{% extends "base.html" %}

{% block title %}文件 - GraceDisk{% endblock %}

{% block content %}
<div class="app-container">
    <!-- Left Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
        <h1>GraceDisk</h1>
        </div>
        
                <div class="sidebar-section">
            <div class="user-info">
                <span>欢迎, <strong>{{ session.username }}</strong>!</span>
            </div>
            <div class="nav-buttons">
                {% if session.is_admin %}
                <a href="{{ url_for('dashboard') }}" class="sidebar-btn nav-btn">
                    <i class="icon">📊</i> 仪表盘
                </a>
                <a href="{{ url_for('manage_users') }}" class="sidebar-btn nav-btn">
                    <i class="icon">👥</i> 用户管理
                </a>
                {% endif %}
                {% if not session.is_visitor %}
                <a href="{{ url_for('manage_shares') }}" class="sidebar-btn nav-btn">
                    <i class="icon">📤</i> 分享管理
                </a>
                {% endif %}
                <a href="{{ url_for('logout') }}" class="sidebar-btn nav-btn sidebar-btn-logout">
                    <i class="icon">🚪</i> 登出
                </a>
            </div>
        </div>

        {% if not session.is_visitor %}
        <div class="sidebar-section">
            <h3>文件操作</h3>
            <button class="sidebar-btn" onclick="createNewFolder()">
                <i class="icon">📁</i> 新建文件夹
            </button>
            <button class="sidebar-btn" onclick="showRenameDialog()">
                <i class="icon">✏️</i> 重命名
            </button>
            <button class="sidebar-btn" onclick="shareSelected()" id="share-btn" disabled>
                <i class="icon">🔗</i> 分享选中
            </button>
            <button class="sidebar-btn" onclick="downloadSelected()" id="download-btn" disabled>
                <i class="icon">⬇️</i> 下载选中
            </button>
            <button class="sidebar-btn sidebar-btn-danger" onclick="deleteSelected()" id="delete-btn" disabled>
                <i class="icon">🗑️</i> 删除选中
            </button>
        </div>
        {% else %}
        <div class="sidebar-section">
            <h3>访客模式</h3>
            <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem; text-align: center; padding: 1rem;">
                您正在以访客身份浏览<br>
                只能预览和下载文件
            </p>
            <button class="sidebar-btn" onclick="downloadSelected()" id="download-btn" disabled>
                <i class="icon">⬇️</i> 下载选中
            </button>
        </div>
        {% endif %}

        <!-- Storage Info -->
        {% if storage_info %}
        <div class="sidebar-section">
            <h3>存储空间</h3>
            <div class="storage-info">
                {% if storage_info.is_disk %}
                    <p><strong>磁盘空间</strong></p>
                    <p>{{ format_file_size(storage_info.used) }} / {{ format_file_size(storage_info.total) }}</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: {{ (storage_info.used / storage_info.total * 100)|round(2) }}%;">
                            {{ (storage_info.used / storage_info.total * 100)|round(2) }}%
                        </div>
                    </div>
                {% else %}
                    <p><strong>个人空间</strong></p>
                    <p>{{ format_file_size(storage_info.used) }} / {{ format_file_size(storage_info.total) }}</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: {{ storage_info.percent }}%;">
                            {{ storage_info.percent }}%
                        </div>
                    </div>
                    {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Main Content -->
    <div class="main-content">
            <!-- Top Bar -->
        <div class="top-bar">
            <nav class="breadcrumbs">
                {% for crumb in breadcrumbs %}
                {% if not loop.last %}
                    <a href="{{ url_for('browse', subpath=crumb.path) if crumb.path else url_for('root') }}">{{ crumb.name }}</a>
                    <span>/</span>
                {% else %}
                    <span>{{ crumb.name }}</span>
                {% endif %}
                {% endfor %}
            </nav>
            
            <div class="top-buttons">
                <a href="{{ url_for('file_history') }}" class="top-btn">
                    <i class="icon">📝</i> 文件历史
                </a>
                <a href="{{ url_for('about') }}" class="top-btn">
                    <i class="icon">ℹ️</i> 关于
                </a>
            </div>
        </div>

            <!-- Upload Zone -->
        {% if not session.is_visitor %}
        <div class="upload-zone" onclick="document.getElementById('file-input').click();" id="upload-zone">
            <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="upload-form">
                <input type="file" name="file" id="file-input" multiple hidden onchange="handleFileUpload(this);">
                <input type="hidden" name="subpath" value="{{ current_subpath }}">
                <div id="upload-content">
                    <p>点击或拖拽文件到此区域以上传</p>
                </div>
                <div id="upload-progress" style="display: none;">
                    <p>正在上传文件...</p>
                    <div class="upload-progress-bar">
                        <div class="upload-progress-fill" id="progress-fill">
                            <span id="upload-percentage">0%</span>
                        </div>
                    </div>
                    <div id="upload-status">准备上传...</div>
                </div>
            </form>
        </div>
        {% endif %}

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- File Browser -->
    <div class="file-browser">
        <table>
                            <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                        </th>
                        <th style="width: 45%;">名称</th>
                        <th>大小</th>
                        <th>修改日期</th>
                        <th style="width: 80px;">操作</th>
                    </tr>
                </thead>
                        <tbody>
                                {% if not items %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 3rem;">这个文件夹是空的</td>
                </tr>
                {% endif %}
                {% for item in items %}
                <tr class="file-row">
                    <td>
                        <input type="checkbox" name="selected-items" value="{{ (current_subpath + '/' + item.name) if current_subpath else item.name }}" onchange="updateButtonStates()">
                    </td>
                    <td>
                        {% set icon_filename = get_icon(item.name, item.is_dir) %}
                        <img src="{{ url_for('static', filename='icons/' + icon_filename) }}" alt="icon" class="icon">

                        {% if item.is_dir %}
                            <a href="{{ url_for('browse', subpath=(current_subpath + '/' + item.name) if current_subpath else item.name) }}">{{ item.name }}</a>
                        {% else %}
                            <span class="file-name">{{ item.name }}</span>
                        {% endif %}
                    </td>
                    <td>{{ format_file_size(item.size) }}</td>
                    <td>{{ item.mtime }}</td>
                    <td>
                        {% if not item.is_dir %}
                        <div class="file-actions">
                            {% if get_file_type(item.name) != 'other' %}
                            <a href="{{ url_for('preview_file', path=(current_subpath + '/' + item.name) if current_subpath else item.name) }}" 
                               class="action-icon preview-icon" title="预览">
                                👁️
                            </a>
                            {% endif %}
                            <a href="{{ url_for('download_file', filename=(current_subpath + '/' + item.name) if current_subpath else item.name) }}" 
                               class="action-icon download-icon" title="下载"
                               onclick="recordDownload('{{ (current_subpath + '/' + item.name) if current_subpath else item.name }}', {{ item.size if item.size != '-' else 0 }})">
                                ⬇️
                            </a>
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                        </tbody>
                    </table>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="new-folder-modal" class="modal">
    <div class="modal-content">
        <h3>新建文件夹</h3>
        <input type="text" id="folder-name-input" placeholder="请输入文件夹名称">
        <div class="modal-buttons">
            <button onclick="confirmCreateFolder()" class="btn">创建</button>
            <button onclick="closeModal('new-folder-modal')" class="btn btn-secondary">取消</button>
        </div>
    </div>
</div>

<div id="rename-modal" class="modal">
    <div class="modal-content">
        <h3>重命名</h3>
        <select id="rename-item-select">
            <option value="">请选择要重命名的项目</option>
            {% for item in items %}
            <option value="{{ (current_subpath + '/' + item.name) if current_subpath else item.name }}">{{ item.name }}</option>
            {% endfor %}
        </select>
        <input type="text" id="new-name-input" placeholder="请输入新名称">
        <div class="modal-buttons">
            <button onclick="confirmRename()" class="btn">重命名</button>
            <button onclick="closeModal('rename-modal')" class="btn btn-secondary">取消</button>
        </div>
                </div>
            </div>

<div id="share-modal" class="modal">
    <div class="modal-content">
        <h3>创建分享链接</h3>
        <div class="form-group">
            <label>保护密码（可选）:</label>
            <input type="password" id="share-password" placeholder="留空表示无密码保护">
        </div>
        <div class="form-group">
            <label>有效期:</label>
            <select id="share-duration">
                <option value="1">1天</option>
                <option value="7">7天</option>
                <option value="30">30天</option>
                <option value="90">90天</option>
                {% if session.is_admin %}
                <option value="-1">永久</option>
        {% endif %}
            </select>
        </div>
        <div class="modal-buttons">
            <button onclick="confirmShare()" class="btn">创建分享</button>
            <button onclick="closeModal('share-modal')" class="btn btn-secondary">取消</button>
        </div>
    </div>
</div>

<script>
function toggleSelectAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('input[name="selected-items"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    updateButtonStates();
}

function updateButtonStates() {
    const checkboxes = document.querySelectorAll('input[name="selected-items"]:checked');
    const shareBtn = document.getElementById('share-btn');
    const downloadBtn = document.getElementById('download-btn');
    const deleteBtn = document.getElementById('delete-btn');
    
    if (checkboxes.length > 0) {
        shareBtn.disabled = false;
        downloadBtn.disabled = false;
        deleteBtn.disabled = false;
    } else {
        shareBtn.disabled = true;
        downloadBtn.disabled = true;
        deleteBtn.disabled = true;
    }
}

function createNewFolder() {
    document.getElementById('new-folder-modal').style.display = 'flex';
}

function showRenameDialog() {
    document.getElementById('rename-modal').style.display = 'flex';
}

function shareSelected() {
    const checkboxes = document.querySelectorAll('input[name="selected-items"]:checked');
    if (checkboxes.length === 0) {
        alert('请先选择要分享的文件');
        return;
    }
    if (checkboxes.length > 1) {
        alert('一次只能分享一个文件');
        return;
    }
    document.getElementById('share-modal').style.display = 'flex';
}

function downloadSelected() {
    const checkboxes = document.querySelectorAll('input[name="selected-items"]:checked');
    if (checkboxes.length === 0) {
        alert('请先选择要下载的项目');
        return;
    }
    
    const items = Array.from(checkboxes).map(cb => cb.value);
    
    // 显示下载提示
    const downloadBtn = document.getElementById('download-btn');
    const originalText = downloadBtn.innerHTML;
    downloadBtn.innerHTML = '<i class="icon">⏳</i> 准备下载...';
    downloadBtn.disabled = true;
    
    fetch('/batch_download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({items: items})
    }).then(response => {
        if (response.ok) {
            return response.json();
        } else {
            return response.json().then(err => {
                throw new Error(err.error || '下载失败');
            })
        }
    }).then(data => {
        if (data.success && data.download_links) {
            // 批量下载文件
            let downloadCount = 0;
            const totalSize = data.total_size;
            const totalFiles = data.total_files;

            // 先提示用户
            alert(`开始下载 ${totalFiles} 个文件，总大小约 ${(totalSize / 1024 / 1024).toFixed(2)} MB\n请点击确认按钮，并且同意浏览器同时下载多个文件`);

            data.download_links.forEach((file, index) => {
                setTimeout(() => {
                    const a = document.createElement('a');
                    a.href = file.url;
                    a.download = file.filename;
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    downloadCount++;
                    if (downloadCount === totalFiles) {
                        downloadBtn.innerHTML = originalText;
                        updateButtonStates();
                    }                    
                }, index * 1000); // 避免浏览器阻止多文件下载
            });
        } else {
            throw new Error(data.error || '下载失败');
        }
    }).catch(error => {
        alert('下载失败: ' + error.message);
        downloadBtn.innerHTML = originalText;
        updateButtonStates();
    });
}

function deleteSelected() {
    const checkboxes = document.querySelectorAll('input[name="selected-items"]:checked');
    if (checkboxes.length === 0) {
        alert('请先选择要删除的项目');
        return;
    }
    
    const items = Array.from(checkboxes).map(cb => cb.value);
    if (confirm(`确定要删除选中的 ${items.length} 个项目吗？此操作无法恢复！`)) {
        fetch('/batch_delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({items: items})
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('删除失败');
            }
        });
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function confirmCreateFolder() {
    const folderName = document.getElementById('folder-name-input').value.trim();
    if (!folderName) {
        alert('请输入文件夹名称');
        return;
    }
    
    fetch('/create_folder', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: folderName,
            subpath: '{{ current_subpath }}'
        })
    }).then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('创建文件夹失败');
        }
    });
}

function confirmRename() {
    const oldPath = document.getElementById('rename-item-select').value;
    const newName = document.getElementById('new-name-input').value.trim();
    
    if (!oldPath || !newName) {
        alert('请选择要重命名的项目并输入新名称');
        return;
    }
    
    fetch('/rename', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            old_path: oldPath,
            new_name: newName
        })
    }).then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('重命名失败');
        }
    });
}

function confirmShare() {
    const checkboxes = document.querySelectorAll('input[name="selected-items"]:checked');
    if (checkboxes.length !== 1) return;
    
    const path = checkboxes[0].value;
    const password = document.getElementById('share-password').value;
    const duration = document.getElementById('share-duration').value;
    
    fetch('/create_share', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            path: path,
            password: password,
            duration: parseInt(duration)
        })
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`分享链接已创建: ${data.link}`);
            closeModal('share-modal');
        } else {
            alert('创建分享失败: ' + data.error);
        }
    });
}

// WebSocket 连接
let socket = null;
let currentUploadId = null;
let isUploading = false;
let socketConnected = false;
let connectionRetries = 0;
const maxRetries = 3;

// 初始化 WebSocket 连接
function initWebSocket() {
    if (socket && socket.connected) {
        return;
    }
    
    // 设置连接配置
    socket = io({
        timeout: 10000,  // 10秒连接超时
        transports: ['websocket', 'polling'],  // 支持降级到轮询
        upgrade: true,
        rememberUpgrade: true
    });
    
    socket.on('connect', function() {
        console.log('WebSocket 连接成功');
        socketConnected = true;
        connectionRetries = 0;
        
        // 隐藏连接状态消息
        hideConnectionStatus();
    });
    
    socket.on('disconnect', function() {
        console.log('WebSocket 连接断开');
        socketConnected = false;
        
        if (isUploading) {
            // 如果正在上传时断开连接，尝试重连
            if (connectionRetries < maxRetries) {
                showConnectionStatus('连接断开，正在重连...', 'warning');
                setTimeout(() => {
                    connectionRetries++;
                    initWebSocket();
                }, 2000);
            } else {
                document.getElementById('upload-status').textContent = '连接断开，上传中断';
                isUploading = false;
                showConnectionStatus('连接失败，请刷新页面重试', 'error');
            }
        }
    });
    
    socket.on('connect_error', function(error) {
        console.error('WebSocket 连接错误:', error);
        socketConnected = false;
        
        if (connectionRetries < maxRetries) {
            const retryTime = Math.min(3, 2 - connectionRetries);
            showConnectionStatus(`连接失败，${retryTime}秒后重试...`, 'error');
            setTimeout(() => {
                connectionRetries++;
                initWebSocket();
            }, retryTime * 1000);
        } else {
            showConnectionStatus('连接失败，请刷新页面重试', 'error');
        }
    });
    
    socket.on('upload_progress', function(data) {
        if (data.upload_id === currentUploadId) {
            updateUploadProgress(data);
        }
    });
    
    socket.on('upload_complete', function(data) {
        if (data.upload_id === currentUploadId) {
            document.getElementById('upload-status').textContent = '上传完成！';
            document.getElementById('progress-fill').style.width = '100%';
            isUploading = false;
            
            // 2秒后刷新页面
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    });
    
    socket.on('upload_error', function(data) {
        if (data.upload_id === currentUploadId) {
            document.getElementById('upload-status').textContent = '上传失败: ' + data.error;
            isUploading = false;
            
            // 恢复上传界面
            setTimeout(() => {
                document.getElementById('upload-content').style.display = 'block';
                document.getElementById('upload-progress').style.display = 'none';
            }, 3000);
        }
    });
}

function showConnectionStatus(message, type) {
    let statusElement = document.getElementById('connection-status');
    if (!statusElement) {
        statusElement = document.createElement('div');
        statusElement.id = 'connection-status';
        statusElement.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 10000;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        `;
        document.body.appendChild(statusElement);
    }
    
    statusElement.textContent = message;
    statusElement.className = type;
    
    if (type === 'error') {
        statusElement.style.backgroundColor = '#ff4757';
        statusElement.style.color = 'white';
    } else if (type === 'warning') {
        statusElement.style.backgroundColor = '#ffa502';
        statusElement.style.color = 'white';
    } else {
        statusElement.style.backgroundColor = '#2ed573';
        statusElement.style.color = 'white';
    }
    
    statusElement.style.display = 'block';
}

function hideConnectionStatus() {
    const statusElement = document.getElementById('connection-status');
    if (statusElement) {
        statusElement.style.display = 'none';
    }
}

// 页面加载时初始化 WebSocket
document.addEventListener('DOMContentLoaded', function() {
    initWebSocket();
});

// 页面卸载前的警告和清理
window.addEventListener('beforeunload', function(e) {
    if (isUploading && socket && socket.connected) {
        // 发送页面卸载事件到后端
        socket.emit('page_unload');
        
        const confirmationMessage = '文件正在上传中，关闭页面将中断上传。确定要离开吗？';
        e.returnValue = confirmationMessage;
        return confirmationMessage;
    }
});

// 页面隐藏时的清理（移动设备、标签页切换等）
window.addEventListener('pagehide', function() {
    if (isUploading && socket && socket.connected) {
        socket.emit('page_unload');
    }
});

function updateUploadProgress(data) {
    const progressFill = document.getElementById('progress-fill');
    const uploadStatus = document.getElementById('upload-status');
    const progressText = document.getElementById('upload-percentage');
    
    // 更新进度条
    progressFill.style.width = data.progress + '%';
    
    // 更新百分比
    if (progressText) {
        progressText.textContent = Math.round(data.progress) + '%';
    }
    
    // 格式化速度和剩余时间
    const speed = formatSpeed(data.speed);
    const eta = formatTime(data.eta);
    const uploadedSize = formatFileSize(data.uploaded_bytes);
    const totalSize = formatFileSize(data.total_bytes);
    
    // 更新状态文本
    uploadStatus.innerHTML = `
        正在上传: ${data.filename}<br>
        进度: ${uploadedSize} / ${totalSize}<br>
        速度: ${speed}<br>
        剩余时间: ${eta}
    `;
}

function formatSpeed(bytesPerSecond) {
    if (bytesPerSecond < 1024) return bytesPerSecond.toFixed(0) + ' B/s';
    if (bytesPerSecond < 1024**2) return (bytesPerSecond/1024).toFixed(2) + ' KB/s';
    if (bytesPerSecond < 1024**3) return (bytesPerSecond/1024**2).toFixed(2) + ' MB/s';
    return (bytesPerSecond/1024**3).toFixed(2) + ' GB/s';
}

function formatTime(seconds) {
    if (!seconds || seconds === Infinity) return '计算中...';
    if (seconds < 60) return Math.round(seconds) + ' 秒';
    if (seconds < 3600) return Math.round(seconds / 60) + ' 分钟';
    return Math.round(seconds / 3600) + ' 小时';
}

function generateUploadId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function handleFileUpload(input) {
    if (input.files.length === 0) return;
    
    const file = input.files[0];
    const fileSize = file.size;
    
    // 前端文件大小检查
    checkFileSize(file).then(canUpload => {
        if (!canUpload) {
            return; // 已在checkFileSize中显示错误信息
        }
        
        // 确保 WebSocket 连接
        if (!socket || !socket.connected) {
            showConnectionStatus('正在连接服务器...', 'warning');
            initWebSocket();
            
            // 等待连接建立（最多等待15秒）
            let waitCount = 0;
            const maxWait = 15;
            const checkConnection = () => {
                if (socket && socket.connected) {
                    hideConnectionStatus();
                    startWebSocketUpload(file);
                } else if (waitCount < maxWait) {
                    waitCount++;
                    setTimeout(checkConnection, 1000);
                } else {
                    showConnectionStatus('连接服务器超时，请刷新页面重试', 'error');
                    isUploading = false;
                }
            };
            setTimeout(checkConnection, 1000);
        } else {
            startWebSocketUpload(file);
        }
        
    }).catch(error => {
        alert('文件检查失败: ' + error.message);
    });
}

function startWebSocketUpload(file) {
    const uploadContent = document.getElementById('upload-content');
    const uploadProgress = document.getElementById('upload-progress');
    const progressFill = document.getElementById('progress-fill');
    const uploadStatus = document.getElementById('upload-status');
    
    // 生成唯一上传ID
    currentUploadId = generateUploadId();
    isUploading = true;
    
    // 显示进度界面
    uploadContent.style.display = 'none';
    uploadProgress.style.display = 'block';
    progressFill.style.width = '0%';
    uploadStatus.innerHTML = `准备上传: ${file.name}<br>连接服务器...`;
    
    // 创建表单数据
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_id', currentUploadId);
    formData.append('subpath', '{{ current_subpath }}');
    
    // 发送上传请求
    fetch('/upload_websocket', {
        method: 'POST',
        headers: {
            'X-Socket-ID': socket.id
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 上传请求已发送，等待 WebSocket 进度更新
            uploadStatus.innerHTML = `正在上传: ${file.name}<br>0% - 等待开始...`;
        } else {
            throw new Error(data.error || '上传启动失败');
        }
    })
    .catch(error => {
        isUploading = false;
        document.getElementById('upload-status').textContent = '上传失败: ' + error.message;
        
        // 恢复上传界面
        setTimeout(() => {
            document.getElementById('upload-content').style.display = 'block';
            document.getElementById('upload-progress').style.display = 'none';
        }, 3000);
    });
}

// 全局文件大小格式化函数
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024**2) return (bytes/1024).toFixed(2) + ' KB';
    if (bytes < 1024**3) return (bytes/1024**2).toFixed(2) + ' MB';
    return (bytes/1024**3).toFixed(2) + ' GB';
}

function checkFileSize(file) {
    return new Promise((resolve, reject) => {
        // 获取用户配额信息
        fetch('/get_user_quota')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || '无法获取配额信息');
                }
                
                const fileSize = file.size;
                const availableSpace = data.quota_bytes - data.used_bytes;
                
                if (fileSize > availableSpace) {
                    alert(`文件过大！\n` +
                          `文件大小: ${formatFileSize(fileSize)}\n` +
                          `剩余空间: ${formatFileSize(availableSpace)}\n` +
                          `请选择较小的文件或清理空间后重试。`);
                    resolve(false);
                } else {
                    resolve(true);
                }
            })
            .catch(error => {
                console.error('检查配额失败:', error);
                // 如果前端检查失败，仍然允许上传（后端会进行最终检查）
                resolve(true);
            });
    });
}

function recordDownload(filePath, fileSize) {
    // 记录下载操作到历史
    fetch('/record_download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            file_path: filePath,
            file_size: fileSize
        })
    }).catch(error => {
        console.log('记录下载历史失败:', error);
    });
}
</script>
{% endblock %}
