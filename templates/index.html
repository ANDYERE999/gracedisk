{% extends "base.html" %}

{% block title %}æ–‡ä»¶ - GraceDisk{% endblock %}

{% block content %}
<div class="app-container">
    <!-- Left Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
        <h1>GraceDisk</h1>
        </div>
        
                <div class="sidebar-section">
            <div class="user-info">
                <span>æ¬¢è¿, <strong>{{ session.username }}</strong>!</span>
            </div>
            <div class="nav-buttons">
                {% if session.is_admin %}
                <a href="{{ url_for('dashboard') }}" class="sidebar-btn nav-btn">
                    <i class="icon">ğŸ“Š</i> ä»ªè¡¨ç›˜
                </a>
                <a href="{{ url_for('manage_users') }}" class="sidebar-btn nav-btn">
                    <i class="icon">ğŸ‘¥</i> ç”¨æˆ·ç®¡ç†
                </a>
                {% endif %}
                {% if not session.is_visitor %}
                <a href="{{ url_for('manage_shares') }}" class="sidebar-btn nav-btn">
                    <i class="icon">ğŸ“¤</i> åˆ†äº«ç®¡ç†
                </a>
                {% endif %}
                <a href="{{ url_for('logout') }}" class="sidebar-btn nav-btn sidebar-btn-logout">
                    <i class="icon">ğŸšª</i> ç™»å‡º
                </a>
            </div>
        </div>

        {% if not session.is_visitor %}
        <div class="sidebar-section">
            <h3>æ–‡ä»¶æ“ä½œ</h3>
            <button class="sidebar-btn" onclick="createNewFolder()">
                <i class="icon">ğŸ“</i> æ–°å»ºæ–‡ä»¶å¤¹
            </button>
            <button class="sidebar-btn" onclick="showRenameDialog()">
                <i class="icon">âœï¸</i> é‡å‘½å
            </button>
            <button class="sidebar-btn" onclick="shareSelected()" id="share-btn" disabled>
                <i class="icon">ğŸ”—</i> åˆ†äº«é€‰ä¸­
            </button>
            <button class="sidebar-btn" onclick="downloadSelected()" id="download-btn" disabled>
                <i class="icon">â¬‡ï¸</i> ä¸‹è½½é€‰ä¸­
            </button>
            <button class="sidebar-btn sidebar-btn-danger" onclick="deleteSelected()" id="delete-btn" disabled>
                <i class="icon">ğŸ—‘ï¸</i> åˆ é™¤é€‰ä¸­
            </button>
        </div>
        {% else %}
        <div class="sidebar-section">
            <h3>è®¿å®¢æ¨¡å¼</h3>
            <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem; text-align: center; padding: 1rem;">
                æ‚¨æ­£åœ¨ä»¥è®¿å®¢èº«ä»½æµè§ˆ<br>
                åªèƒ½é¢„è§ˆå’Œä¸‹è½½æ–‡ä»¶
            </p>
            <button class="sidebar-btn" onclick="downloadSelected()" id="download-btn" disabled>
                <i class="icon">â¬‡ï¸</i> ä¸‹è½½é€‰ä¸­
            </button>
        </div>
        {% endif %}

        <!-- Storage Info -->
        {% if storage_info %}
        <div class="sidebar-section">
            <h3>å­˜å‚¨ç©ºé—´</h3>
            <div class="storage-info">
                {% if storage_info.is_disk %}
                    <p><strong>ç£ç›˜ç©ºé—´</strong></p>
                    <p>{{ format_file_size(storage_info.used) }} / {{ format_file_size(storage_info.total) }}</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: {{ (storage_info.used / storage_info.total * 100)|round(2) }}%;">
                            {{ (storage_info.used / storage_info.total * 100)|round(2) }}%
                        </div>
                    </div>
                {% else %}
                    <p><strong>ä¸ªäººç©ºé—´</strong></p>
                    <p>{{ format_file_size(storage_info.used) }} / {{ format_file_size(storage_info.total) }}</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: {{ storage_info.percent }}%;">
                            {{ storage_info.percent }}%
                        </div>
                    </div>
                    {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Main Content -->
    <div class="main-content">
            <!-- Top Bar -->
        <div class="top-bar">
            <nav class="breadcrumbs">
                {% for crumb in breadcrumbs %}
                {% if not loop.last %}
                    <a href="{{ url_for('browse', subpath=crumb.path) if crumb.path else url_for('root') }}">{{ crumb.name }}</a>
                    <span>/</span>
                {% else %}
                    <span>{{ crumb.name }}</span>
                {% endif %}
                {% endfor %}
            </nav>
            
            <div class="top-buttons">
                <a href="{{ url_for('file_history') }}" class="top-btn">
                    <i class="icon">ğŸ“</i> æ–‡ä»¶å†å²
                </a>
                <a href="{{ url_for('about') }}" class="top-btn">
                    <i class="icon">â„¹ï¸</i> å…³äº
                </a>
            </div>
        </div>

            <!-- Upload Zone -->
        {% if not session.is_visitor %}
        <div class="upload-zone" onclick="document.getElementById('file-input').click();" id="upload-zone">
            <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="upload-form">
                <input type="file" name="file" id="file-input" multiple hidden onchange="handleFileUpload(this);">
                <input type="hidden" name="subpath" value="{{ current_subpath }}">
                <div id="upload-content">
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸä»¥ä¸Šä¼ </p>
                </div>
                <div id="upload-progress" style="display: none;">
                    <p>æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...</p>
                    <div class="upload-progress-bar">
                        <div class="upload-progress-fill" id="progress-fill">
                            <span id="upload-percentage">0%</span>
                        </div>
                    </div>
                    <div id="upload-status">å‡†å¤‡ä¸Šä¼ ...</div>
                </div>
            </form>
        </div>
        {% endif %}

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- File Browser -->
    <div class="file-browser">
        <table>
                            <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                        </th>
                        <th style="width: 45%;">åç§°</th>
                        <th>å¤§å°</th>
                        <th>ä¿®æ”¹æ—¥æœŸ</th>
                        <th style="width: 80px;">æ“ä½œ</th>
                    </tr>
                </thead>
                        <tbody>
                                {% if not items %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 3rem;">è¿™ä¸ªæ–‡ä»¶å¤¹æ˜¯ç©ºçš„</td>
                </tr>
                {% endif %}
                {% for item in items %}
                <tr class="file-row">
                    <td>
                        <input type="checkbox" name="selected-items" value="{{ (current_subpath + '/' + item.name) if current_subpath else item.name }}" onchange="updateButtonStates()">
                    </td>
                    <td>
                        {% set icon_filename = get_icon(item.name, item.is_dir) %}
                        <img src="{{ url_for('static', filename='icons/' + icon_filename) }}" alt="icon" class="icon">

                        {% if item.is_dir %}
                            <a href="{{ url_for('browse', subpath=(current_subpath + '/' + item.name) if current_subpath else item.name) }}">{{ item.name }}</a>
                        {% else %}
                            <span class="file-name">{{ item.name }}</span>
                        {% endif %}
                    </td>
                    <td>{{ format_file_size(item.size) }}</td>
                    <td>{{ item.mtime }}</td>
                    <td>
                        {% if not item.is_dir %}
                        <div class="file-actions">
                            {% if get_file_type(item.name) != 'other' %}
                            <a href="{{ url_for('preview_file', path=(current_subpath + '/' + item.name) if current_subpath else item.name) }}" 
                               class="action-icon preview-icon" title="é¢„è§ˆ">
                                ğŸ‘ï¸
                            </a>
                            {% endif %}
                            <a href="{{ url_for('download_file', filename=(current_subpath + '/' + item.name) if current_subpath else item.name) }}" 
                               class="action-icon download-icon" title="ä¸‹è½½"
                               onclick="recordDownload('{{ (current_subpath + '/' + item.name) if current_subpath else item.name }}', {{ item.size if item.size != '-' else 0 }})">
                                â¬‡ï¸
                            </a>
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                        </tbody>
                    </table>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="new-folder-modal" class="modal">
    <div class="modal-content">
        <h3>æ–°å»ºæ–‡ä»¶å¤¹</h3>
        <input type="text" id="folder-name-input" placeholder="è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°">
        <div class="modal-buttons">
            <button onclick="confirmCreateFolder()" class="btn">åˆ›å»º</button>
            <button onclick="closeModal('new-folder-modal')" class="btn btn-secondary">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="rename-modal" class="modal">
    <div class="modal-content">
        <h3>é‡å‘½å</h3>
        <select id="rename-item-select">
            <option value="">è¯·é€‰æ‹©è¦é‡å‘½åçš„é¡¹ç›®</option>
            {% for item in items %}
            <option value="{{ (current_subpath + '/' + item.name) if current_subpath else item.name }}">{{ item.name }}</option>
            {% endfor %}
        </select>
        <input type="text" id="new-name-input" placeholder="è¯·è¾“å…¥æ–°åç§°">
        <div class="modal-buttons">
            <button onclick="confirmRename()" class="btn">é‡å‘½å</button>
            <button onclick="closeModal('rename-modal')" class="btn btn-secondary">å–æ¶ˆ</button>
        </div>
                </div>
            </div>

<div id="share-modal" class="modal">
    <div class="modal-content">
        <h3>åˆ›å»ºåˆ†äº«é“¾æ¥</h3>
        <div class="form-group">
            <label>ä¿æŠ¤å¯†ç ï¼ˆå¯é€‰ï¼‰:</label>
            <input type="password" id="share-password" placeholder="ç•™ç©ºè¡¨ç¤ºæ— å¯†ç ä¿æŠ¤">
        </div>
        <div class="form-group">
            <label>æœ‰æ•ˆæœŸ:</label>
            <select id="share-duration">
                <option value="1">1å¤©</option>
                <option value="7">7å¤©</option>
                <option value="30">30å¤©</option>
                <option value="90">90å¤©</option>
                {% if session.is_admin %}
                <option value="-1">æ°¸ä¹…</option>
        {% endif %}
            </select>
        </div>
        <div class="modal-buttons">
            <button onclick="confirmShare()" class="btn">åˆ›å»ºåˆ†äº«</button>
            <button onclick="closeModal('share-modal')" class="btn btn-secondary">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
function toggleSelectAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('input[name="selected-items"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    updateButtonStates();
}

function updateButtonStates() {
    const checkboxes = document.querySelectorAll('input[name="selected-items"]:checked');
    const shareBtn = document.getElementById('share-btn');
    const downloadBtn = document.getElementById('download-btn');
    const deleteBtn = document.getElementById('delete-btn');
    
    if (checkboxes.length > 0) {
        shareBtn.disabled = false;
        downloadBtn.disabled = false;
        deleteBtn.disabled = false;
    } else {
        shareBtn.disabled = true;
        downloadBtn.disabled = true;
        deleteBtn.disabled = true;
    }
}

function createNewFolder() {
    document.getElementById('new-folder-modal').style.display = 'flex';
}

function showRenameDialog() {
    document.getElementById('rename-modal').style.display = 'flex';
}

function shareSelected() {
    const checkboxes = document.querySelectorAll('input[name="selected-items"]:checked');
    if (checkboxes.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦åˆ†äº«çš„æ–‡ä»¶');
        return;
    }
    if (checkboxes.length > 1) {
        alert('ä¸€æ¬¡åªèƒ½åˆ†äº«ä¸€ä¸ªæ–‡ä»¶');
        return;
    }
    document.getElementById('share-modal').style.display = 'flex';
}

function downloadSelected() {
    const checkboxes = document.querySelectorAll('input[name="selected-items"]:checked');
    if (checkboxes.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„é¡¹ç›®');
        return;
    }
    
    const items = Array.from(checkboxes).map(cb => cb.value);
    
    // æ˜¾ç¤ºä¸‹è½½æç¤º
    const downloadBtn = document.getElementById('download-btn');
    const originalText = downloadBtn.innerHTML;
    downloadBtn.innerHTML = '<i class="icon">â³</i> å‡†å¤‡ä¸‹è½½...';
    downloadBtn.disabled = true;
    
    fetch('/batch_download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({items: items})
    }).then(response => {
        if (response.ok) {
            return response.json();
        } else {
            return response.json().then(err => {
                throw new Error(err.error || 'ä¸‹è½½å¤±è´¥');
            })
        }
    }).then(data => {
        if (data.success && data.download_links) {
            // æ‰¹é‡ä¸‹è½½æ–‡ä»¶
            let downloadCount = 0;
            const totalSize = data.total_size;
            const totalFiles = data.total_files;

            // å…ˆæç¤ºç”¨æˆ·
            alert(`å¼€å§‹ä¸‹è½½ ${totalFiles} ä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å°çº¦ ${(totalSize / 1024 / 1024).toFixed(2)} MB\nè¯·ç‚¹å‡»ç¡®è®¤æŒ‰é’®ï¼Œå¹¶ä¸”åŒæ„æµè§ˆå™¨åŒæ—¶ä¸‹è½½å¤šä¸ªæ–‡ä»¶`);

            data.download_links.forEach((file, index) => {
                setTimeout(() => {
                    const a = document.createElement('a');
                    a.href = file.url;
                    a.download = file.filename;
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    downloadCount++;
                    if (downloadCount === totalFiles) {
                        downloadBtn.innerHTML = originalText;
                        updateButtonStates();
                    }                    
                }, index * 1000); // é¿å…æµè§ˆå™¨é˜»æ­¢å¤šæ–‡ä»¶ä¸‹è½½
            });
        } else {
            throw new Error(data.error || 'ä¸‹è½½å¤±è´¥');
        }
    }).catch(error => {
        alert('ä¸‹è½½å¤±è´¥: ' + error.message);
        downloadBtn.innerHTML = originalText;
        updateButtonStates();
    });
}

function deleteSelected() {
    const checkboxes = document.querySelectorAll('input[name="selected-items"]:checked');
    if (checkboxes.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®');
        return;
    }
    
    const items = Array.from(checkboxes).map(cb => cb.value);
    if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${items.length} ä¸ªé¡¹ç›®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ¢å¤ï¼`)) {
        fetch('/batch_delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({items: items})
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('åˆ é™¤å¤±è´¥');
            }
        });
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function confirmCreateFolder() {
    const folderName = document.getElementById('folder-name-input').value.trim();
    if (!folderName) {
        alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°');
        return;
    }
    
    fetch('/create_folder', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: folderName,
            subpath: '{{ current_subpath }}'
        })
    }).then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥');
        }
    });
}

function confirmRename() {
    const oldPath = document.getElementById('rename-item-select').value;
    const newName = document.getElementById('new-name-input').value.trim();
    
    if (!oldPath || !newName) {
        alert('è¯·é€‰æ‹©è¦é‡å‘½åçš„é¡¹ç›®å¹¶è¾“å…¥æ–°åç§°');
        return;
    }
    
    fetch('/rename', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            old_path: oldPath,
            new_name: newName
        })
    }).then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('é‡å‘½åå¤±è´¥');
        }
    });
}

function confirmShare() {
    const checkboxes = document.querySelectorAll('input[name="selected-items"]:checked');
    if (checkboxes.length !== 1) return;
    
    const path = checkboxes[0].value;
    const password = document.getElementById('share-password').value;
    const duration = document.getElementById('share-duration').value;
    
    fetch('/create_share', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            path: path,
            password: password,
            duration: parseInt(duration)
        })
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`åˆ†äº«é“¾æ¥å·²åˆ›å»º: ${data.link}`);
            closeModal('share-modal');
        } else {
            alert('åˆ›å»ºåˆ†äº«å¤±è´¥: ' + data.error);
        }
    });
}

// WebSocket è¿æ¥
let socket = null;
let currentUploadId = null;
let isUploading = false;
let socketConnected = false;
let connectionRetries = 0;
const maxRetries = 3;

// åˆå§‹åŒ– WebSocket è¿æ¥
function initWebSocket() {
    if (socket && socket.connected) {
        return;
    }
    
    // è®¾ç½®è¿æ¥é…ç½®
    socket = io({
        timeout: 10000,  // 10ç§’è¿æ¥è¶…æ—¶
        transports: ['websocket', 'polling'],  // æ”¯æŒé™çº§åˆ°è½®è¯¢
        upgrade: true,
        rememberUpgrade: true
    });
    
    socket.on('connect', function() {
        console.log('WebSocket è¿æ¥æˆåŠŸ');
        socketConnected = true;
        connectionRetries = 0;
        
        // éšè—è¿æ¥çŠ¶æ€æ¶ˆæ¯
        hideConnectionStatus();
    });
    
    socket.on('disconnect', function() {
        console.log('WebSocket è¿æ¥æ–­å¼€');
        socketConnected = false;
        
        if (isUploading) {
            // å¦‚æœæ­£åœ¨ä¸Šä¼ æ—¶æ–­å¼€è¿æ¥ï¼Œå°è¯•é‡è¿
            if (connectionRetries < maxRetries) {
                showConnectionStatus('è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...', 'warning');
                setTimeout(() => {
                    connectionRetries++;
                    initWebSocket();
                }, 2000);
            } else {
                document.getElementById('upload-status').textContent = 'è¿æ¥æ–­å¼€ï¼Œä¸Šä¼ ä¸­æ–­';
                isUploading = false;
                showConnectionStatus('è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            }
        }
    });
    
    socket.on('connect_error', function(error) {
        console.error('WebSocket è¿æ¥é”™è¯¯:', error);
        socketConnected = false;
        
        if (connectionRetries < maxRetries) {
            const retryTime = Math.min(3, 2 - connectionRetries);
            showConnectionStatus(`è¿æ¥å¤±è´¥ï¼Œ${retryTime}ç§’åé‡è¯•...`, 'error');
            setTimeout(() => {
                connectionRetries++;
                initWebSocket();
            }, retryTime * 1000);
        } else {
            showConnectionStatus('è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        }
    });
    
    socket.on('upload_progress', function(data) {
        if (data.upload_id === currentUploadId) {
            updateUploadProgress(data);
        }
    });
    
    socket.on('upload_complete', function(data) {
        if (data.upload_id === currentUploadId) {
            document.getElementById('upload-status').textContent = 'ä¸Šä¼ å®Œæˆï¼';
            document.getElementById('progress-fill').style.width = '100%';
            isUploading = false;
            
            // 2ç§’ååˆ·æ–°é¡µé¢
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    });
    
    socket.on('upload_error', function(data) {
        if (data.upload_id === currentUploadId) {
            document.getElementById('upload-status').textContent = 'ä¸Šä¼ å¤±è´¥: ' + data.error;
            isUploading = false;
            
            // æ¢å¤ä¸Šä¼ ç•Œé¢
            setTimeout(() => {
                document.getElementById('upload-content').style.display = 'block';
                document.getElementById('upload-progress').style.display = 'none';
            }, 3000);
        }
    });
}

function showConnectionStatus(message, type) {
    let statusElement = document.getElementById('connection-status');
    if (!statusElement) {
        statusElement = document.createElement('div');
        statusElement.id = 'connection-status';
        statusElement.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 10000;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        `;
        document.body.appendChild(statusElement);
    }
    
    statusElement.textContent = message;
    statusElement.className = type;
    
    if (type === 'error') {
        statusElement.style.backgroundColor = '#ff4757';
        statusElement.style.color = 'white';
    } else if (type === 'warning') {
        statusElement.style.backgroundColor = '#ffa502';
        statusElement.style.color = 'white';
    } else {
        statusElement.style.backgroundColor = '#2ed573';
        statusElement.style.color = 'white';
    }
    
    statusElement.style.display = 'block';
}

function hideConnectionStatus() {
    const statusElement = document.getElementById('connection-status');
    if (statusElement) {
        statusElement.style.display = 'none';
    }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– WebSocket
document.addEventListener('DOMContentLoaded', function() {
    initWebSocket();
});

// é¡µé¢å¸è½½å‰çš„è­¦å‘Šå’Œæ¸…ç†
window.addEventListener('beforeunload', function(e) {
    if (isUploading && socket && socket.connected) {
        // å‘é€é¡µé¢å¸è½½äº‹ä»¶åˆ°åç«¯
        socket.emit('page_unload');
        
        const confirmationMessage = 'æ–‡ä»¶æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œå…³é—­é¡µé¢å°†ä¸­æ–­ä¸Šä¼ ã€‚ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
        e.returnValue = confirmationMessage;
        return confirmationMessage;
    }
});

// é¡µé¢éšè—æ—¶çš„æ¸…ç†ï¼ˆç§»åŠ¨è®¾å¤‡ã€æ ‡ç­¾é¡µåˆ‡æ¢ç­‰ï¼‰
window.addEventListener('pagehide', function() {
    if (isUploading && socket && socket.connected) {
        socket.emit('page_unload');
    }
});

function updateUploadProgress(data) {
    const progressFill = document.getElementById('progress-fill');
    const uploadStatus = document.getElementById('upload-status');
    const progressText = document.getElementById('upload-percentage');
    
    // æ›´æ–°è¿›åº¦æ¡
    progressFill.style.width = data.progress + '%';
    
    // æ›´æ–°ç™¾åˆ†æ¯”
    if (progressText) {
        progressText.textContent = Math.round(data.progress) + '%';
    }
    
    // æ ¼å¼åŒ–é€Ÿåº¦å’Œå‰©ä½™æ—¶é—´
    const speed = formatSpeed(data.speed);
    const eta = formatTime(data.eta);
    const uploadedSize = formatFileSize(data.uploaded_bytes);
    const totalSize = formatFileSize(data.total_bytes);
    
    // æ›´æ–°çŠ¶æ€æ–‡æœ¬
    uploadStatus.innerHTML = `
        æ­£åœ¨ä¸Šä¼ : ${data.filename}<br>
        è¿›åº¦: ${uploadedSize} / ${totalSize}<br>
        é€Ÿåº¦: ${speed}<br>
        å‰©ä½™æ—¶é—´: ${eta}
    `;
}

function formatSpeed(bytesPerSecond) {
    if (bytesPerSecond < 1024) return bytesPerSecond.toFixed(0) + ' B/s';
    if (bytesPerSecond < 1024**2) return (bytesPerSecond/1024).toFixed(2) + ' KB/s';
    if (bytesPerSecond < 1024**3) return (bytesPerSecond/1024**2).toFixed(2) + ' MB/s';
    return (bytesPerSecond/1024**3).toFixed(2) + ' GB/s';
}

function formatTime(seconds) {
    if (!seconds || seconds === Infinity) return 'è®¡ç®—ä¸­...';
    if (seconds < 60) return Math.round(seconds) + ' ç§’';
    if (seconds < 3600) return Math.round(seconds / 60) + ' åˆ†é’Ÿ';
    return Math.round(seconds / 3600) + ' å°æ—¶';
}

function generateUploadId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function handleFileUpload(input) {
    if (input.files.length === 0) return;
    
    const file = input.files[0];
    const fileSize = file.size;
    
    // å‰ç«¯æ–‡ä»¶å¤§å°æ£€æŸ¥
    checkFileSize(file).then(canUpload => {
        if (!canUpload) {
            return; // å·²åœ¨checkFileSizeä¸­æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        }
        
        // ç¡®ä¿ WebSocket è¿æ¥
        if (!socket || !socket.connected) {
            showConnectionStatus('æ­£åœ¨è¿æ¥æœåŠ¡å™¨...', 'warning');
            initWebSocket();
            
            // ç­‰å¾…è¿æ¥å»ºç«‹ï¼ˆæœ€å¤šç­‰å¾…15ç§’ï¼‰
            let waitCount = 0;
            const maxWait = 15;
            const checkConnection = () => {
                if (socket && socket.connected) {
                    hideConnectionStatus();
                    startWebSocketUpload(file);
                } else if (waitCount < maxWait) {
                    waitCount++;
                    setTimeout(checkConnection, 1000);
                } else {
                    showConnectionStatus('è¿æ¥æœåŠ¡å™¨è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                    isUploading = false;
                }
            };
            setTimeout(checkConnection, 1000);
        } else {
            startWebSocketUpload(file);
        }
        
    }).catch(error => {
        alert('æ–‡ä»¶æ£€æŸ¥å¤±è´¥: ' + error.message);
    });
}

function startWebSocketUpload(file) {
    const uploadContent = document.getElementById('upload-content');
    const uploadProgress = document.getElementById('upload-progress');
    const progressFill = document.getElementById('progress-fill');
    const uploadStatus = document.getElementById('upload-status');
    
    // ç”Ÿæˆå”¯ä¸€ä¸Šä¼ ID
    currentUploadId = generateUploadId();
    isUploading = true;
    
    // æ˜¾ç¤ºè¿›åº¦ç•Œé¢
    uploadContent.style.display = 'none';
    uploadProgress.style.display = 'block';
    progressFill.style.width = '0%';
    uploadStatus.innerHTML = `å‡†å¤‡ä¸Šä¼ : ${file.name}<br>è¿æ¥æœåŠ¡å™¨...`;
    
    // åˆ›å»ºè¡¨å•æ•°æ®
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_id', currentUploadId);
    formData.append('subpath', '{{ current_subpath }}');
    
    // å‘é€ä¸Šä¼ è¯·æ±‚
    fetch('/upload_websocket', {
        method: 'POST',
        headers: {
            'X-Socket-ID': socket.id
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ä¸Šä¼ è¯·æ±‚å·²å‘é€ï¼Œç­‰å¾… WebSocket è¿›åº¦æ›´æ–°
            uploadStatus.innerHTML = `æ­£åœ¨ä¸Šä¼ : ${file.name}<br>0% - ç­‰å¾…å¼€å§‹...`;
        } else {
            throw new Error(data.error || 'ä¸Šä¼ å¯åŠ¨å¤±è´¥');
        }
    })
    .catch(error => {
        isUploading = false;
        document.getElementById('upload-status').textContent = 'ä¸Šä¼ å¤±è´¥: ' + error.message;
        
        // æ¢å¤ä¸Šä¼ ç•Œé¢
        setTimeout(() => {
            document.getElementById('upload-content').style.display = 'block';
            document.getElementById('upload-progress').style.display = 'none';
        }, 3000);
    });
}

// å…¨å±€æ–‡ä»¶å¤§å°æ ¼å¼åŒ–å‡½æ•°
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024**2) return (bytes/1024).toFixed(2) + ' KB';
    if (bytes < 1024**3) return (bytes/1024**2).toFixed(2) + ' MB';
    return (bytes/1024**3).toFixed(2) + ' GB';
}

function checkFileSize(file) {
    return new Promise((resolve, reject) => {
        // è·å–ç”¨æˆ·é…é¢ä¿¡æ¯
        fetch('/get_user_quota')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'æ— æ³•è·å–é…é¢ä¿¡æ¯');
                }
                
                const fileSize = file.size;
                const availableSpace = data.quota_bytes - data.used_bytes;
                
                if (fileSize > availableSpace) {
                    alert(`æ–‡ä»¶è¿‡å¤§ï¼\n` +
                          `æ–‡ä»¶å¤§å°: ${formatFileSize(fileSize)}\n` +
                          `å‰©ä½™ç©ºé—´: ${formatFileSize(availableSpace)}\n` +
                          `è¯·é€‰æ‹©è¾ƒå°çš„æ–‡ä»¶æˆ–æ¸…ç†ç©ºé—´åé‡è¯•ã€‚`);
                    resolve(false);
                } else {
                    resolve(true);
                }
            })
            .catch(error => {
                console.error('æ£€æŸ¥é…é¢å¤±è´¥:', error);
                // å¦‚æœå‰ç«¯æ£€æŸ¥å¤±è´¥ï¼Œä»ç„¶å…è®¸ä¸Šä¼ ï¼ˆåç«¯ä¼šè¿›è¡Œæœ€ç»ˆæ£€æŸ¥ï¼‰
                resolve(true);
            });
    });
}

function recordDownload(filePath, fileSize) {
    // è®°å½•ä¸‹è½½æ“ä½œåˆ°å†å²
    fetch('/record_download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            file_path: filePath,
            file_size: fileSize
        })
    }).catch(error => {
        console.log('è®°å½•ä¸‹è½½å†å²å¤±è´¥:', error);
    });
}
</script>
{% endblock %}
