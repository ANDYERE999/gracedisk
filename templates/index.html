{% extends "base.html" %}

{% block title %}æ–‡ä»¶ - GraceDisk{% endblock %}

{% block content %}
<div class="app-container">
    <!-- Left Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
        <h1>GraceDisk</h1>
        </div>
        
                <div class="sidebar-section">
            <div class="user-info">
                <span>æ¬¢è¿, <strong>{{ session.username }}</strong>!</span>
            </div>
            <div class="nav-buttons">
                {% if session.is_admin %}
                <a href="{{ url_for('dashboard') }}" class="sidebar-btn nav-btn">
                    <i class="icon">ğŸ“Š</i> ä»ªè¡¨ç›˜
                </a>
                <a href="{{ url_for('manage_users') }}" class="sidebar-btn nav-btn">
                    <i class="icon">ğŸ‘¥</i> ç”¨æˆ·ç®¡ç†
                </a>
                {% endif %}
                {% if not session.is_visitor %}
                <a href="{{ url_for('manage_shares') }}" class="sidebar-btn nav-btn">
                    <i class="icon">ğŸ“¤</i> åˆ†äº«ç®¡ç†
                </a>
                {% endif %}
                <a href="{{ url_for('logout') }}" class="sidebar-btn nav-btn sidebar-btn-logout">
                    <i class="icon">ğŸšª</i> ç™»å‡º
                </a>
            </div>
        </div>

        {% if not session.is_visitor %}
        <div class="sidebar-section">
            <h3>æ–‡ä»¶æ“ä½œ</h3>
            <button class="sidebar-btn" onclick="createNewFolder()">
                <i class="icon">ğŸ“</i> æ–°å»ºæ–‡ä»¶å¤¹
            </button>
            <button class="sidebar-btn" onclick="showRenameDialog()">
                <i class="icon">âœï¸</i> é‡å‘½å
            </button>
            <button class="sidebar-btn" onclick="shareSelected()" id="share-btn" disabled>
                <i class="icon">ğŸ”—</i> åˆ†äº«é€‰ä¸­
            </button>
            <button class="sidebar-btn" onclick="downloadSelected()" id="download-btn" disabled>
                <i class="icon">â¬‡ï¸</i> ä¸‹è½½é€‰ä¸­
            </button>
            <button class="sidebar-btn sidebar-btn-danger" onclick="deleteSelected()" id="delete-btn" disabled>
                <i class="icon">ğŸ—‘ï¸</i> åˆ é™¤é€‰ä¸­
            </button>
        </div>
        {% else %}
        <div class="sidebar-section">
            <h3>è®¿å®¢æ¨¡å¼</h3>
            <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem; text-align: center; padding: 1rem;">
                æ‚¨æ­£åœ¨ä»¥è®¿å®¢èº«ä»½æµè§ˆ<br>
                åªèƒ½é¢„è§ˆå’Œä¸‹è½½æ–‡ä»¶
            </p>
            <button class="sidebar-btn" onclick="downloadSelected()" id="download-btn" disabled>
                <i class="icon">â¬‡ï¸</i> ä¸‹è½½é€‰ä¸­
            </button>
        </div>
        {% endif %}

        <!-- Storage Info -->
        {% if storage_info %}
        <div class="sidebar-section">
            <h3>å­˜å‚¨ç©ºé—´</h3>
            <div class="storage-info">
                {% if storage_info.is_disk %}
                    <p><strong>ç£ç›˜ç©ºé—´</strong></p>
                    <p>{{ format_file_size(storage_info.used) }} / {{ format_file_size(storage_info.total) }}</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: {{ (storage_info.used / storage_info.total * 100)|round(2) }}%;">
                            {{ (storage_info.used / storage_info.total * 100)|round(2) }}%
                        </div>
                    </div>
                {% else %}
                    <p><strong>ä¸ªäººç©ºé—´</strong></p>
                    <p>{{ format_file_size(storage_info.used) }} / {{ format_file_size(storage_info.total) }}</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: {{ storage_info.percent }}%;">
                            {{ storage_info.percent }}%
                        </div>
                    </div>
                    {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Main Content -->
    <div class="main-content">
            <!-- Top Bar -->
        <div class="top-bar">
            <nav class="breadcrumbs">
                {% for crumb in breadcrumbs %}
                {% if not loop.last %}
                    <a href="{{ url_for('browse', subpath=crumb.path) if crumb.path else url_for('root') }}">{{ crumb.name }}</a>
                    <span>/</span>
                {% else %}
                    <span>{{ crumb.name }}</span>
                {% endif %}
                {% endfor %}
            </nav>
            
            <div class="top-buttons">
                <a href="{{ url_for('file_history') }}" class="top-btn">
                    <i class="icon">ğŸ“</i> æ–‡ä»¶å†å²
                </a>
                <a href="{{ url_for('about') }}" class="top-btn">
                    <i class="icon">â„¹ï¸</i> å…³äº
                </a>
            </div>
        </div>

            <!-- Upload Zone -->
        {% if not session.is_visitor %}
        <div class="upload-zone" onclick="document.getElementById('file-input').click();" id="upload-zone">
            <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="upload-form">
                <input type="file" name="file" id="file-input" multiple hidden onchange="handleFileUpload(this);">
                <input type="hidden" name="subpath" value="{{ current_subpath }}">
                <div id="upload-content">
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸä»¥ä¸Šä¼ </p>
                </div>
                <div id="upload-progress" style="display: none;">
                    <p>æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...</p>
                    <div class="upload-progress-bar">
                        <div class="upload-progress-fill" id="progress-fill"></div>
                    </div>
                    <div id="upload-status">å‡†å¤‡ä¸Šä¼ ...</div>
                </div>
            </form>
        </div>
        {% endif %}

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- File Browser -->
    <div class="file-browser">
        <table>
                            <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                        </th>
                        <th style="width: 45%;">åç§°</th>
                        <th>å¤§å°</th>
                        <th>ä¿®æ”¹æ—¥æœŸ</th>
                        <th style="width: 80px;">æ“ä½œ</th>
                    </tr>
                </thead>
                        <tbody>
                                {% if not items %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 3rem;">è¿™ä¸ªæ–‡ä»¶å¤¹æ˜¯ç©ºçš„</td>
                </tr>
                {% endif %}
                {% for item in items %}
                <tr class="file-row">
                    <td>
                        <input type="checkbox" name="selected-items" value="{{ (current_subpath + '/' + item.name) if current_subpath else item.name }}" onchange="updateButtonStates()">
                    </td>
                    <td>
                        {% set icon_filename = get_icon(item.name, item.is_dir) %}
                        <img src="{{ url_for('static', filename='icons/' + icon_filename) }}" alt="icon" class="icon">

                        {% if item.is_dir %}
                            <a href="{{ url_for('browse', subpath=(current_subpath + '/' + item.name) if current_subpath else item.name) }}">{{ item.name }}</a>
                        {% else %}
                            <span class="file-name">{{ item.name }}</span>
                        {% endif %}
                    </td>
                    <td>{{ format_file_size(item.size) }}</td>
                    <td>{{ item.mtime }}</td>
                    <td>
                        {% if not item.is_dir %}
                        <div class="file-actions">
                            {% if get_file_type(item.name) != 'other' %}
                            <a href="{{ url_for('preview_file', path=(current_subpath + '/' + item.name) if current_subpath else item.name) }}" 
                               class="action-icon preview-icon" title="é¢„è§ˆ">
                                ğŸ‘ï¸
                            </a>
                            {% endif %}
                            <a href="{{ url_for('download_file', filename=(current_subpath + '/' + item.name) if current_subpath else item.name) }}" 
                               class="action-icon download-icon" title="ä¸‹è½½"
                               onclick="recordDownload('{{ (current_subpath + '/' + item.name) if current_subpath else item.name }}', {{ item.size if item.size != '-' else 0 }})">
                                â¬‡ï¸
                            </a>
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                        </tbody>
                    </table>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="new-folder-modal" class="modal">
    <div class="modal-content">
        <h3>æ–°å»ºæ–‡ä»¶å¤¹</h3>
        <input type="text" id="folder-name-input" placeholder="è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°">
        <div class="modal-buttons">
            <button onclick="confirmCreateFolder()" class="btn">åˆ›å»º</button>
            <button onclick="closeModal('new-folder-modal')" class="btn btn-secondary">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="rename-modal" class="modal">
    <div class="modal-content">
        <h3>é‡å‘½å</h3>
        <select id="rename-item-select">
            <option value="">è¯·é€‰æ‹©è¦é‡å‘½åçš„é¡¹ç›®</option>
            {% for item in items %}
            <option value="{{ (current_subpath + '/' + item.name) if current_subpath else item.name }}">{{ item.name }}</option>
            {% endfor %}
        </select>
        <input type="text" id="new-name-input" placeholder="è¯·è¾“å…¥æ–°åç§°">
        <div class="modal-buttons">
            <button onclick="confirmRename()" class="btn">é‡å‘½å</button>
            <button onclick="closeModal('rename-modal')" class="btn btn-secondary">å–æ¶ˆ</button>
        </div>
                </div>
            </div>

<div id="share-modal" class="modal">
    <div class="modal-content">
        <h3>åˆ›å»ºåˆ†äº«é“¾æ¥</h3>
        <div class="form-group">
            <label>ä¿æŠ¤å¯†ç ï¼ˆå¯é€‰ï¼‰:</label>
            <input type="password" id="share-password" placeholder="ç•™ç©ºè¡¨ç¤ºæ— å¯†ç ä¿æŠ¤">
        </div>
        <div class="form-group">
            <label>æœ‰æ•ˆæœŸ:</label>
            <select id="share-duration">
                <option value="1">1å¤©</option>
                <option value="7">7å¤©</option>
                <option value="30">30å¤©</option>
                <option value="90">90å¤©</option>
                {% if session.is_admin %}
                <option value="-1">æ°¸ä¹…</option>
        {% endif %}
            </select>
        </div>
        <div class="modal-buttons">
            <button onclick="confirmShare()" class="btn">åˆ›å»ºåˆ†äº«</button>
            <button onclick="closeModal('share-modal')" class="btn btn-secondary">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
function toggleSelectAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('input[name="selected-items"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    updateButtonStates();
}

function updateButtonStates() {
    const checkboxes = document.querySelectorAll('input[name="selected-items"]:checked');
    const shareBtn = document.getElementById('share-btn');
    const downloadBtn = document.getElementById('download-btn');
    const deleteBtn = document.getElementById('delete-btn');
    
    if (checkboxes.length > 0) {
        shareBtn.disabled = false;
        downloadBtn.disabled = false;
        deleteBtn.disabled = false;
    } else {
        shareBtn.disabled = true;
        downloadBtn.disabled = true;
        deleteBtn.disabled = true;
    }
}

function createNewFolder() {
    document.getElementById('new-folder-modal').style.display = 'flex';
}

function showRenameDialog() {
    document.getElementById('rename-modal').style.display = 'flex';
}

function shareSelected() {
    const checkboxes = document.querySelectorAll('input[name="selected-items"]:checked');
    if (checkboxes.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦åˆ†äº«çš„æ–‡ä»¶');
        return;
    }
    if (checkboxes.length > 1) {
        alert('ä¸€æ¬¡åªèƒ½åˆ†äº«ä¸€ä¸ªæ–‡ä»¶');
        return;
    }
    document.getElementById('share-modal').style.display = 'flex';
}

function downloadSelected() {
    const checkboxes = document.querySelectorAll('input[name="selected-items"]:checked');
    if (checkboxes.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„é¡¹ç›®');
        return;
    }
    
    const items = Array.from(checkboxes).map(cb => cb.value);
    
    // æ˜¾ç¤ºä¸‹è½½æç¤º
    const downloadBtn = document.getElementById('download-btn');
    const originalText = downloadBtn.innerHTML;
    downloadBtn.innerHTML = '<i class="icon">â³</i> æ‰“åŒ…ä¸­...';
    downloadBtn.disabled = true;
    
    fetch('/batch_download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({items: items})
    }).then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('ä¸‹è½½å¤±è´¥');
        }
    }).then(blob => {
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        
        // ç”Ÿæˆæ–‡ä»¶å
        const timestamp = new Date().toISOString().slice(0,19).replace(/[-:T]/g, '');
        a.download = `gracedisk_files_${timestamp}.zip`;
        
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        downloadBtn.innerHTML = originalText;
        updateButtonStates();
    }).catch(error => {
        alert('ä¸‹è½½å¤±è´¥: ' + error.message);
        downloadBtn.innerHTML = originalText;
        updateButtonStates();
    });
}

function deleteSelected() {
    const checkboxes = document.querySelectorAll('input[name="selected-items"]:checked');
    if (checkboxes.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®');
        return;
    }
    
    const items = Array.from(checkboxes).map(cb => cb.value);
    if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${items.length} ä¸ªé¡¹ç›®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ¢å¤ï¼`)) {
        fetch('/batch_delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({items: items})
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('åˆ é™¤å¤±è´¥');
            }
        });
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function confirmCreateFolder() {
    const folderName = document.getElementById('folder-name-input').value.trim();
    if (!folderName) {
        alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°');
        return;
    }
    
    fetch('/create_folder', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: folderName,
            subpath: '{{ current_subpath }}'
        })
    }).then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥');
        }
    });
}

function confirmRename() {
    const oldPath = document.getElementById('rename-item-select').value;
    const newName = document.getElementById('new-name-input').value.trim();
    
    if (!oldPath || !newName) {
        alert('è¯·é€‰æ‹©è¦é‡å‘½åçš„é¡¹ç›®å¹¶è¾“å…¥æ–°åç§°');
        return;
    }
    
    fetch('/rename', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            old_path: oldPath,
            new_name: newName
        })
    }).then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('é‡å‘½åå¤±è´¥');
        }
    });
}

function confirmShare() {
    const checkboxes = document.querySelectorAll('input[name="selected-items"]:checked');
    if (checkboxes.length !== 1) return;
    
    const path = checkboxes[0].value;
    const password = document.getElementById('share-password').value;
    const duration = document.getElementById('share-duration').value;
    
    fetch('/create_share', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            path: path,
            password: password,
            duration: parseInt(duration)
        })
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`åˆ†äº«é“¾æ¥å·²åˆ›å»º: ${data.link}`);
            closeModal('share-modal');
        } else {
            alert('åˆ›å»ºåˆ†äº«å¤±è´¥: ' + data.error);
        }
    });
}

function handleFileUpload(input) {
    if (input.files.length === 0) return;
    
    const uploadContent = document.getElementById('upload-content');
    const uploadProgress = document.getElementById('upload-progress');
    const progressFill = document.getElementById('progress-fill');
    const uploadStatus = document.getElementById('upload-status');
    
    // æ˜¾ç¤ºè¿›åº¦ç•Œé¢
    uploadContent.style.display = 'none';
    uploadProgress.style.display = 'block';
    
    // æ¨¡æ‹Ÿä¸Šä¼ è¿›åº¦
    let progress = 0;
    uploadStatus.textContent = `æ­£åœ¨ä¸Šä¼ : ${input.files[0].name}`;
    
    const progressInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress >= 95) {
            progress = 95;
            uploadStatus.textContent = 'æ­£åœ¨å¤„ç†æ–‡ä»¶...';
        }
        progressFill.style.width = progress + '%';
        
        if (progress >= 95) {
            clearInterval(progressInterval);
            // å®é™…æäº¤è¡¨å•
            document.getElementById('upload-form').submit();
        }
    }, 100);
}

function recordDownload(filePath, fileSize) {
    // è®°å½•ä¸‹è½½æ“ä½œåˆ°å†å²
    fetch('/record_download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            file_path: filePath,
            file_size: fileSize
        })
    }).catch(error => {
        console.log('è®°å½•ä¸‹è½½å†å²å¤±è´¥:', error);
    });
}
</script>
{% endblock %}
